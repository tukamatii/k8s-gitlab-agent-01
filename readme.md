# GitLab Kubernetes Agent: –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è CI/CD —Å –ø–ª–∞—Ç—Ñ–æ—Ä–º–æ–π

- [GitLab Kubernetes Agent: –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è CI/CD —Å –ø–ª–∞—Ç—Ñ–æ—Ä–º–æ–π](#gitlab-kubernetes-agent-–±–µ–∑–æ–ø–∞—Å–Ω–∞—è-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è-cicd-—Å-–ø–ª–∞—Ç—Ñ–æ—Ä–º–æ–π)
  - [–ó–∞—á–µ–º –Ω—É–∂–µ–Ω —ç—Ç–æ—Ç –∫–æ–º–ø–æ–Ω–µ–Ω—Ç](#–∑–∞—á–µ–º-–Ω—É–∂–µ–Ω-—ç—Ç–æ—Ç-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç)
  - [–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: –ø—Ä–∏–Ω—Ü–∏–ø –º–∏–Ω–∏–º–∞–ª—å–Ω—ã—Ö –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π](#–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å-–ø—Ä–∏–Ω—Ü–∏–ø-–º–∏–Ω–∏–º–∞–ª—å–Ω—ã—Ö-–ø—Ä–∏–≤–∏–ª–µ–≥–∏–π)
    - [1. –ì—Ä–∞–Ω—É–ª—è—Ä–Ω—ã–π RBAC](#1-–≥—Ä–∞–Ω—É–ª—è—Ä–Ω—ã–π-rbac)
    - [2. –°—Ç—Ä–æ–≥–∞—è —Å–µ–≥—Ä–µ–≥–∞—Ü–∏—è –¥–æ—Å—Ç—É–ø–∞](#2-—Å—Ç—Ä–æ–≥–∞—è-—Å–µ–≥—Ä–µ–≥–∞—Ü–∏—è-–¥–æ—Å—Ç—É–ø–∞)
    - [3. –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ–∫—Ä–µ—Ç–∞–º–∏](#3-–±–µ–∑–æ–ø–∞—Å–Ω–æ–µ-—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ-—Å–µ–∫—Ä–µ—Ç–∞–º–∏)
  - [–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π](#–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è-—Å-–∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π)
    - [1. Multi-–∫–ª–∞—Å—Ç–µ—Ä–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞](#1-multi-–∫–ª–∞—Å—Ç–µ—Ä–Ω–∞—è-–ø–æ–¥–¥–µ—Ä–∂–∫–∞)
    - [2. –û—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∏ placement](#2-–æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å-–∏-placement)
    - [3. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ observability](#3-–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥-–∏-observability)
  - [–ü—Ä–æ—Ü–µ—Å—Å —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è —á–µ—Ä–µ–∑ Fleet](#–ø—Ä–æ—Ü–µ—Å—Å-—Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è-—á–µ—Ä–µ–∑-fleet)
  - [–†–∞–±–æ—á–∏–µ –ø—Ä–∏–º–µ—Ä—ã –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤](#—Ä–∞–±–æ—á–∏–µ-–ø—Ä–∏–º–µ—Ä—ã-–¥–ª—è-—Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤)
    - [1. –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è](#1-–±–µ–∑–æ–ø–∞—Å–Ω–æ–µ-—Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è)
    - [2. –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –¥–ª—è feature-–≤–µ—Ç–∫–∏](#2-–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ-–æ–∫—Ä—É–∂–µ–Ω–∏–µ-–¥–ª—è-feature-–≤–µ—Ç–∫–∏)
    - [3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–µ—Ä–µ–¥ —Ä–µ–ª–∏–∑–æ–º](#3-–ø—Ä–æ–≤–µ—Ä–∫–∞-—Å–æ—Å—Ç–æ—è–Ω–∏—è-–ø–µ—Ä–µ–¥-—Ä–µ–ª–∏–∑–æ–º)
  - [Production-—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏](#production-—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏)

## –ó–∞—á–µ–º –Ω—É–∂–µ–Ω —ç—Ç–æ—Ç –∫–æ–º–ø–æ–Ω–µ–Ω—Ç

GitLab Kubernetes Agent –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç **–±–µ–∑–æ–ø–∞—Å–Ω—ã–π –¥–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω–∏–π –∫–∞–Ω–∞–ª —Å–≤—è–∑–∏** –º–µ–∂–¥—É GitLab –∏ Kubernetes-–∫–ª–∞—Å—Ç–µ—Ä–æ–º, —Ä–µ—à–∞—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Ç—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞:

- üîí **–£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –¥–∞–≤–∞—Ç—å GitLab –ø—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø –∫ kubeconfig** (—Ç—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥ —Ç—Ä–µ–±—É–µ—Ç –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –∫–ª–∞—Å—Ç–µ—Ä–Ω—ã—Ö –ø—Ä–∞–≤ GitLab runner'–∞–º)
- üö¶ **–ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º—ã–π RBAC** —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–º–∏ –ø—Ä–∏–≤–∏–ª–µ–≥–∏—è–º–∏ –¥–ª—è CI/CD –ø–∞–π–ø–ª–∞–π–Ω–æ–≤
- üì° **Pull-based –º–æ–¥–µ–ª—å** –≤–º–µ—Å—Ç–æ push (–∞–≥–µ–Ω—Ç —Å–∞–º –æ–ø—Ä–∞—à–∏–≤–∞–µ—Ç GitLab, –∞ –Ω–µ –Ω–∞–æ–±–æ—Ä–æ—Ç), —á—Ç–æ –∏–¥–µ–∞–ª—å–Ω–æ –¥–ª—è —Å—Ä–µ–¥ —Å strict firewall policies
- üîÑ **–ï–¥–∏–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è** —á–µ—Ä–µ–∑ familiar GitOps workflow –≤ GitLab UI
- üë• **–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞** –º–µ–∂–¥—É –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–º–∏ –∫–æ–º–∞–Ω–¥–∞–º–∏ –∏ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞–º–∏

**–ö–ª—é—á–µ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:**

- –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π —á–µ—Ä–µ–∑ GitLab CI –±–µ–∑ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è cluster-admin –ø—Ä–∞–≤
- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è feature-–≤–µ—Ç–æ–∫ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—á–∏—Å—Ç–∫–æ–π
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–ª–∞—Å—Ç–µ—Ä–∞ –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ –≤ GitLab UI
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Kubernetes API –¥–ª—è custom CI/CD –ª–æ–≥–∏–∫–∏ (–ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–¥–æ–≤ –ø–µ—Ä–µ–¥ —Ä–µ–ª–∏–∑–æ–º)

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: –ø—Ä–∏–Ω—Ü–∏–ø –º–∏–Ω–∏–º–∞–ª—å–Ω—ã—Ö –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π

### 1. –ì—Ä–∞–Ω—É–ª—è—Ä–Ω—ã–π RBAC

```yaml
# gitlab-agent/additional/sa.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
rules:
  # Core API (—Ç–æ–ª—å–∫–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ä–µ—Å—É—Ä—Å—ã)
  - apiGroups: [""]
    resources: ["pods", "services", "endpoints", "configmaps", "secrets"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]

  # Workloads (–ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø, –Ω–æ —Ç–æ–ª—å–∫–æ –≤ —Ä–∞–º–∫–∞—Ö namespace)
  - apiGroups: ["apps"]
    resources: ["deployments", "statefulsets", "daemonsets", "replicasets"]
    verbs: ["*"]

  # Prometheus Operator CRDs (–¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π)
  - apiGroups: ["monitoring.coreos.com"]
    resources: ["servicemonitors", "podmonitors", "prometheusrules"]
    verbs: ["*"]

  # External Secrets –∏ Gateway API (—Å–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞)
  - apiGroups: ["external-secrets.io"]
    resources: ["externalsecrets"]
    verbs: ["*"]
  - apiGroups: ["gateway.networking.k8s.io"]
    resources: ["httproutes"]
    verbs: ["*"]
```

### 2. –°—Ç—Ä–æ–≥–∞—è —Å–µ–≥—Ä–µ–≥–∞—Ü–∏—è –¥–æ—Å—Ç—É–ø–∞

```yaml
# .gitlab/agents/k8s-gitlab-agent-01/config.yaml
ci_access:
  groups:
    - id: oit/k8s
    - id: oit/services

user_access:
  access_as:
    agent: {}
  groups:
    - id: oit/k8s
    - id: oit/services
```

- **–¢–æ–ª—å–∫–æ –≥—Ä—É–ø–ø—ã `oit/k8s` –∏ `oit/services`** –∏–º–µ—é—Ç –¥–æ—Å—Ç—É–ø –∫ –∫–ª–∞—Å—Ç–µ—Ä—É
- **–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ ClusterRoleBinding, StorageClass, Node** –∏ –¥—Ä—É–≥–∏–º –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–º —Ä–µ—Å—É—Ä—Å–∞–º
- **–û—Ç–¥–µ–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞ –¥–ª—è CI –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π** —á–µ—Ä–µ–∑ GitLab RBAC

### 3. –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ–∫—Ä–µ—Ç–∞–º–∏

```yaml
# gitlab-token/helm/templates/external-secret.yaml
apiVersion: external-secrets.io/v1
kind: ExternalSecret
spec:
  secretStoreRef:
    name: bitwarden-secretsmanager
    kind: ClusterSecretStore
  target:
    name: agent-secret
    template:
      data:
        token: '{{ printf "{{ index . %q }}" .Values.clusterName }}'
  dataFrom:
    - extract:
        key: gitlab-agent-tokens
```

- –¢–æ–∫–µ–Ω—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ **Bitwarden, –∞ –Ω–µ –≤ Git –∏–ª–∏ ConfigMap**
- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏–º–µ–Ω–∏ –∫–ª–∞—Å—Ç–µ—Ä–∞
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–æ—Ç–∞—Ü–∏—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –≤ Bitwarden

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π

### 1. Multi-–∫–ª–∞—Å—Ç–µ—Ä–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞

```yaml
# fleet.yaml
targetCustomizations:
  - name: prod
    clusterSelector:
      matchLabels:
        okbtsp.corp/template: talos-vmware
```

- –ï–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è –≤—Å–µ—Ö –∫–ª–∞—Å—Ç–µ—Ä–æ–≤ —Å –º–µ—Ç–∫–æ–π `talos-vmware`
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–ª–∞—Å—Ç–µ—Ä–∞
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–∞–∫ development (rancher-k3s), —Ç–∞–∫ –∏ production (talos-vmware) —Å—Ä–µ–¥

### 2. –û—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∏ placement

```yaml
# agent-values.yaml
tolerations:
  - key: "node-role.kubernetes.io/infra"
    operator: "Equal"
    value: ""
    effect: "NoSchedule"
affinity:
  nodeAffinity:
    requiredDuringSchedulingIgnoredDuringExecution:
      nodeSelectorTerms:
        - matchExpressions:
            - key: node-role.kubernetes.io/infra
              operator: In
              values: [""]
```

- –ó–∞–ø—É—Å–∫ **—Ç–æ–ª—å–∫–æ –Ω–∞ –≤—ã–¥–µ–ª–µ–Ω–Ω—ã—Ö infra-–Ω–æ–¥–∞—Ö**
- –†–µ—Å—É—Ä—Å—ã —Å—Ç—Ä–æ–≥–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω—ã (100m CPU, 128Mi RAM)
- –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (`runAsNonRoot: true`)

### 3. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ observability

```yaml
serviceMonitor:
  enabled: true
```

- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ ServiceMonitor –¥–ª—è Prometheus
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º —Å—Ç–µ–∫–æ–º –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
- –°–±–æ—Ä –º–µ—Ç—Ä–∏–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤ –∞–≥–µ–Ω—Ç–æ–º

## –ü—Ä–æ—Ü–µ—Å—Å —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è —á–µ—Ä–µ–∑ Fleet

```mermaid
graph TD
    A[Fleet GitRepo] -->|–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è| B[gitlab-token]
    B -->|–°–æ–∑–¥–∞–Ω–∏–µ ExternalSecret| C[Bitwarden Secrets Manager]
    C -->|–ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞| D[gitlab-agent]
    D -->|Helm —É—Å—Ç–∞–Ω–æ–≤–∫–∞| E[GitLab Agent Pod]
    E -->|WSS —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ| F[GitLab KAS]
```

1. **–®–∞–≥ 1:** –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
   ```yaml
   dependsOn:
     - name: external-secrets
     - name: prom-operator
     - name: gitlab-token
   ```
2. **–®–∞–≥ 2:** –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞
   - –°–æ–∑–¥–∞–Ω–∏–µ ExternalSecret –¥–ª—è —Ç–æ–∫–µ–Ω–∞ –∞–≥–µ–Ω—Ç–∞
3. **–®–∞–≥ 3:** –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∞–≥–µ–Ω—Ç–∞
   - Helm chart –≤–µ—Ä—Å–∏–∏ 2.21.0
   - –ö–∞—Å—Ç–æ–º–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ RBAC
   - –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ KAS

## –†–∞–±–æ—á–∏–µ –ø—Ä–∏–º–µ—Ä—ã –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤

### 1. –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

```yaml
# .gitlab-ci.yml
deploy_to_production:
  stage: deploy
  image: registry.okbtsp.corp/oit/k8s-tools:latest
  script:
    - kubectl apply -f k8s/production-manifests/
  environment:
    name: production
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
```

### 2. –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –¥–ª—è feature-–≤–µ—Ç–∫–∏

```yaml
# .gitlab-ci.yml
deploy_review:
  stage: deploy
  script:
    - kubectl apply -f k8s/review-manifests/ -n review-$CI_COMMIT_REF_SLUG
  environment:
    name: review/$CI_COMMIT_REF_NAME
    url: https://review-$CI_COMMIT_REF_SLUG.app.okbtsp.corp
    on_stop: stop_review
  rules:
    - if: $CI_COMMIT_BRANCH != "main"
```

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–µ—Ä–µ–¥ —Ä–µ–ª–∏–∑–æ–º

```yaml
# .gitlab-ci.yml
verify_deployment:
  stage: verify
  script:
    - kubectl wait --for=condition=available deployment/my-app --timeout=300s -n production
```

## Production-—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–†–æ—Ç–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–æ–≤:**

   - –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é —Ä–æ—Ç–∞—Ü–∏—é —Ç–æ–∫–µ–Ω–æ–≤ –≤ Bitwarden –∫–∞–∂–¥—ã–µ 90 –¥–Ω–µ–π
   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ push-–º–µ—Ö–∞–Ω–∏–∑–º ExternalSecrets –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–æ–≤—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤

2. **–ê—É–¥–∏—Ç –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:**

   ```yaml
   # –î–æ–±–∞–≤—å—Ç–µ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∞–≥–µ–Ω—Ç–∞
   config:
     log_level: info
     log_format: json
   ```

   - –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π —Å–±–æ—Ä –ª–æ–≥–æ–≤ —á–µ—Ä–µ–∑ Loki
   - –ê—É–¥–∏—Ç –≤—Å–µ—Ö –¥–µ–π—Å—Ç–≤–∏–π GitLab —á–µ—Ä–µ–∑ Kubernetes audit logs

3. **–ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ:**

   - –î–ª—è –∫–ª–∞—Å—Ç–µ—Ä–æ–≤ —Å > 50 –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–∞–π–ø–ª–∞–π–Ω–æ–≤ —É–≤–µ–ª–∏—á—å—Ç–µ —Ä–µ—Å—É—Ä—Å—ã –¥–æ 500m CPU/512Mi RAM
   - –†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∞–≥–µ–Ω—Ç–æ–≤ —Å —Ä–∞–∑–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –∫–æ–º–∞–Ω–¥

4. **Disaster Recovery:**

   - –•—Ä–∞–Ω–∏—Ç–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∞–≥–µ–Ω—Ç–∞ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º Git-—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
   - –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Fleet –ø—Ä–∏ –ø–æ—Ç–µ—Ä–µ –∫–ª–∞—Å—Ç–µ—Ä–∞

5. **GitOps-–ø–∞—Ç—Ç–µ—Ä–Ω:**
   ```yaml
   # –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π workflow
   Feature Branch --> Merge Request --> Security Scan --> Auto-Deploy to Review --> Manual Approval --> Production
   ```

> **–í–∞–∂–Ω–æ:** GitLab Agent –≤ —ç—Ç–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ ‚Äî —ç—Ç–æ –Ω–µ –∑–∞–º–µ–Ω–∞ Argo CD, –∞ –¥–æ–ø–æ–ª–Ω—è—é—â–∏–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è CI/CD –ø–∞–π–ø–ª–∞–π–Ω–æ–≤. Argo CD —É–ø—Ä–∞–≤–ª—è–µ—Ç –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π –∏ –±–∞–∑–æ–≤—ã–º–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏ —á–µ—Ä–µ–∑ Fleet, –∞ GitLab Agent –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞–º –±–µ–∑–æ–ø–∞—Å–Ω—ã–π —Å–ø–æ—Å–æ–± —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –∏—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π. –¢–∞–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ —á–µ—Ç–∫–æ —Ä–∞–∑–¥–µ–ª—è–µ—Ç –∑–æ–Ω—ã –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –∏ –º–∏–Ω–∏–º–∏–∑–∏—Ä—É–µ—Ç —Ä–∏—Å–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏. –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –¥–∞–≤–∞–π—Ç–µ –∞–≥–µ–Ω—Ç—É –ø—Ä–∞–≤–∞ –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ ‚Äî —Ç–æ–ª—å–∫–æ –Ω–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è–º–∏ –≤ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –≤—ã–¥–µ–ª–µ–Ω–Ω—ã—Ö namespace.
